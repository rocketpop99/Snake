<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PyScript Snake Game</title>
  <!-- Load PyScript resources -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <style>
    body {
      margin: 0;
      background: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      border: 2px solid #fff;
      background: #111;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="400" height="400"></canvas>

  <py-script>
import random
from js import document, window

# Setup the canvas and context.
canvas = document.getElementById("gameCanvas")
ctx = canvas.getContext("2d")

# Define game settings.
tile_size = 20
cols = canvas.width // tile_size
rows = canvas.height // tile_size

# Initialize the snake (list of (x, y) tuples).
snake = [(5, 5), (4, 5), (3, 5)]
direction = (1, 0)  # moving right initially

# Place the first apple randomly.
apple = (random.randint(0, cols - 1), random.randint(0, rows - 1))
speed = 100  # game loop interval in milliseconds

def draw():
    # Clear the canvas.
    ctx.fillStyle = "#111"
    ctx.fillRect(0, 0, canvas.width, canvas.height)
    
    # Draw the apple.
    ctx.fillStyle = "red"
    ctx.fillRect(apple[0] * tile_size, apple[1] * tile_size, tile_size, tile_size)
    
    # Draw the snake.
    ctx.fillStyle = "lime"
    for segment in snake:
        ctx.fillRect(segment[0] * tile_size, segment[1] * tile_size, tile_size, tile_size)

def update():
    global snake, apple
    # Calculate the new head based on the current direction.
    head = snake[0]
    new_head = ((head[0] + direction[0]) % cols, (head[1] + direction[1]) % rows)
    
    # Check for self-collision. If so, reset the snake.
    if new_head in snake:
        snake[:] = [(5, 5), (4, 5), (3, 5)]
        return
    
    # Insert the new head at the beginning.
    snake.insert(0, new_head)
    
    # If the snake eats the apple, generate a new apple position.
    if new_head == apple:
        while True:
            new_apple = (random.randint(0, cols - 1), random.randint(0, rows - 1))
            if new_apple not in snake:
                apple = new_apple
                break
    else:
        # Remove the tail segment.
        snake.pop()

def game_loop(event=None):
    update()
    draw()

def key_down(event):
    global direction
    key = event.key
    if key == "ArrowUp" and direction != (0, 1):
        direction = (0, -1)
    elif key == "ArrowDown" and direction != (0, -1):
        direction = (0, 1)
    elif key == "ArrowLeft" and direction != (1, 0):
        direction = (-1, 0)
    elif key == "ArrowRight" and direction != (-1, 0):
        direction = (1, 0)

# Listen for keydown events.
document.addEventListener("keydown", key_down)

# Initial draw.
draw()

# Start the game loop using setInterval.
window.setInterval(game_loop, speed)
  </py-script>
</body>
</html>
